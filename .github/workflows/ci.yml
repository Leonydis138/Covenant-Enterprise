name: CI - Covenant.AI Enhanced

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # -------------------------
  # Lint & Test Job (CPU/GPU)
  # -------------------------
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
        compute: ['cpu', 'gpu']
      fail-fast: false

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/pip
            ~/.cache/torch
            ~/.cache/huggingface
          key: deps-${{ runner.os }}-py${{ matrix.python-version }}-${{ matrix.compute }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            deps-${{ runner.os }}-py${{ matrix.python-version }}-${{ matrix.compute }}-

      # Install lightweight dependencies first
      - name: Install lightweight dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install numpy pandas scipy --prefer-binary
          pip install web3 ipfshttpclient openai anthropic google-generativeai prometheus-client jaeger-client --prefer-binary
          pip install pytest pytest-cov black mypy pylint --prefer-binary

      # Install heavy ML dependencies conditionally
      - name: Install ML dependencies
        run: |
          if [ "${{ matrix.compute }}" == "cpu" ]; then
            pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu --prefer-binary
            pip install faiss-cpu --prefer-binary
          else
            pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118 --prefer-binary
            pip install faiss-gpu --prefer-binary
          fi
          pip install transformers sentence-transformers --prefer-binary

      # Install local editable project
      - name: Install Covenant-Enterprise
        run: pip install -e ./src

      # Format, type-check, lint
      - name: Auto-format with Black
        run: black ./src tests

      - name: Format check (Black)
        run: black --check ./src tests

      - name: Type check (mypy)
        run: mypy ./src --ignore-missing-imports

      - name: Lint (pylint)
        run: pylint ./src || true

      # Run tests & coverage
      - name: Run tests
        run: pytest tests --cov=./src --cov-report=xml --junitxml=junit/results.xml

      - name: Smoke tests
        run: |
          python workflows/01_setup_environment.py
          python workflows/09_run_basic_tests.py

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}-${{ matrix.compute }}
          path: coverage.xml

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.python-version }}-${{ matrix.compute }}
          path: |
            junit/
            coverage.xml
            workflow_setup.log

  # -------------------------
  # Security Scan Job
  # -------------------------
  security:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    needs: lint-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Security Tools
        run: |
          pip install safety==3.6.0 typer==0.9.0 "rich<14"

      - name: Run Safety Security Scan
        run: |
          if [ -f requirements.txt ]; then
            safety check \
              --disable-audit-and-monitor \
              --full-report \
              --file=requirements.txt \
              --json > safety-report-${{ matrix.python-version }}.json || true
          else
            echo "::warning::No requirements.txt found â€” skipping Safety scan"

      - name: Upload Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report-${{ matrix.python-version }}
          path: safety-report-${{ matrix.python-version }}.json

  # -------------------------
  # Merge Security Reports + Coverage
  # -------------------------
  merge-security-reports:
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Download all Safety reports
        uses: actions/download-artifact@v4
        with:
          path: safety-reports

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports

      - name: Merge Safety reports and print CI summary
        run: |
          python - <<'EOF'
          import json, glob, xml.etree.ElementTree as ET, sys

          vuln_summary = {}
          merged_vulns = []
          for file in glob.glob("safety-reports/*.json"):
              py_version = file.split("-")[-1].replace(".json", "")
              with open(file) as f:
                  data = json.load(f)
                  vuln_count = len(data) if isinstance(data, list) else 0
                  vuln_summary[py_version] = vuln_count
                  merged_vulns.extend(data if isinstance(data, list) else [])

          coverage_summary = {}
          for file in glob.glob("coverage-reports/coverage-*.xml"):
              py_version = file.split("-")[-1].replace(".xml", "")
              tree = ET.parse(file)
              root = tree.getroot()
              coverage_summary[py_version] = float(root.attrib.get("line-rate", 0.0)) * 100

          print("\n### CI SUMMARY TABLE ###\n")
          print("{:<10} | {:<15} | {:<12} | {:<7}".format("Python", "Coverage %", "Vulnerabilities", "Status"))
          print("-" * 50)
          for py_version in sorted(set(list(vuln_summary.keys()) + list(coverage_summary.keys()))):
              cov = coverage_summary.get(py_version, 0.0)
              vulns = vuln_summary.get(py_version, 0)
              status = "âœ…" if vulns == 0 else "âš ï¸"
              print("{:<10} | {:<15.1f} | {:<12} | {:<7}".format(py_version, cov, vulns, status))
          print("\n")

          with open("merged-safety-report.json", "w") as f:
              json.dump(merged_vulns, f, indent=2)

          if merged_vulns:
              print("âŒ Vulnerabilities detected! Failing workflow.")
              sys.exit(1)
          else:
              print("âœ… No vulnerabilities detected.")
          EOF

      - name: Upload merged Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merged-safety-report
          path: merged-safety-report.json

  # -------------------------
  # Docker Build Job
  # -------------------------
  build-docker:
    needs: [lint-and-test, merge-security-reports]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: covenant-ai-enhanced:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -------------------------
  # PR Comment with Safety + Coverage
  # -------------------------
  pr-comment:
    runs-on: ubuntu-latest
    needs: merge-security-reports
    if: github.event_name == 'pull_request'
    steps:
      - name: Download merged Safety report
        uses: actions/download-artifact@v4
        with:
          name: merged-safety-report
          path: ./reports

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: ./coverage-reports

      - name: Generate PR comment
        id: generate_comment
        run: |
          python - <<'EOF'
          import json, glob, xml.etree.ElementTree as ET

          comment_md = "### ðŸ›¡ï¸ Safety Scan & Test Coverage Summary ðŸ›¡ï¸\n\n"

          comment_md += "**Safety Scan:**\n"
          comment_md += "| Python Version | Vulnerabilities |\n"
          comment_md += "|---------------|----------------|\n"
          total_vulns = 0
          for file in glob.glob("reports/*.json"):
              py_version = file.split("-")[-1].replace(".json", "")
              with open(file) as f:
                  data = json.load(f)
                  count = len(data) if isinstance(data, list) else 0
                  total_vulns += count
                  comment_md += f"| {py_version} | {count} |\n"
          comment_md += f"\n**Total vulnerabilities:** {total_vulns}\n"
          if total_vulns == 0:
              comment_md += "âœ… No vulnerabilities detected.\n"
          else:
              comment_md += "âŒ Vulnerabilities detected! Please review.\n"

          comment_md += "\n**Test Coverage:**\n"
          comment_md += "| Python Version | Coverage % |\n"
          comment_md += "|---------------|------------|\n"
          for file in glob.glob("coverage-reports/coverage-*.xml"):
              py_version = file.split("-")[-1].replace(".xml", "")
              tree = ET.parse(file)
              root = tree.getroot()
              coverage_percent = float(root.attrib.get("line-rate", 0.0)) * 100
              comment_md += f"| {py_version} | {coverage_percent:.1f}% |\n"
          comment_md += "\n"

          with open("pr_comment.md", "w") as f:
              f.write(comment_md)
          EOF

      - name: Post comment to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            $(cat pr_comment.md)

  # -------------------------
  # Notification Job
  # -------------------------
  notify:
    needs: [lint-and-test, merge-security-reports, build-docker]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify on failure
        if: failure()
        run: echo "CI failed - check GitHub Actions logs"
