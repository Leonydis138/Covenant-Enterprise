lint-and-test:
  runs-on: ubuntu-latest
  strategy:
    matrix:
      python-version: ['3.9', '3.10']  # Torch 2.0 compatible
    fail-fast: false

  steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: false

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        pip install numpy pandas scipy transformers sentence-transformers faiss-cpu \
                    web3 ipfshttpclient openai anthropic google-generativeai \
                    prometheus-client jaeger-client \
                    pytest pytest-cov black mypy pylint
        pip install -e .

    - name: Format check (Black)
      run: black --check covenant tests

    - name: Type check (mypy)
      run: mypy covenant --ignore-missing-imports

    - name: Lint (pylint)
      run: pylint covenant || true

    - name: Run tests
      run: pytest tests --cov=covenant --cov-report=xml --junitxml=junit/results.xml

    - name: Smoke tests
      run: |
        python workflows/01_setup_environment.py
        python workflows/09_run_basic_tests.py
