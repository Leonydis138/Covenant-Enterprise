name: CI - Covenant.AI Enhanced

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # -------------------------
  # Lint & Test Job
  # -------------------------
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Upgrade pip and setuptools
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies
        run: |
          # Install PyTorch with compatible versions for Python 3.11
          # Using latest stable versions that are compatible with each other
          pip install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1 --index-url https://download.pytorch.org/whl/cpu
          
          # Install the rest of dependencies
          pip install numpy pandas scipy transformers sentence-transformers faiss-cpu \
                      web3 ipfshttpclient openai anthropic google-generativeai \
                      prometheus-client jaeger-client \
                      pytest pytest-cov black mypy pylint isort
          
          # Install project in development mode
          pip install -e .

      - name: Auto-format with Black
        run: black src tests

      - name: Check formatting (Black)
        run: black --check src tests

      - name: Sort imports (isort)
        run: isort src tests --check-only

      - name: Type check
        run: mypy src

      - name: Lint (pylint)
        run: pylint src || true

      - name: Run tests
        run: pytest tests --cov=src --cov-report=xml --junitxml=junit/results.xml

      - name: Smoke tests
        run: |
          python workflows/01_setup_environment.py
          python workflows/09_run_basic_tests.py

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.python-version }}
          path: |
            junit/
            coverage.xml
            workflow_setup.log

  # -------------------------
  # Security Scan Job
  # -------------------------
  security:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    needs: lint-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Security Tools
        run: |
          pip install safety==3.6.0 typer==0.9.0 "rich<14"

      - name: Run Safety Security Scan
        run: |
          # First generate requirements.txt from installed packages
          pip freeze > requirements.txt
          echo "Generated requirements.txt with $(wc -l < requirements.txt) packages"
          
          safety check \
            --disable-audit-and-monitor \
            --full-report \
            --file=requirements.txt \
            --json > safety-report-${{ matrix.python-version }}.json || echo "[]" > safety-report-${{ matrix.python-version }}.json

      - name: Upload Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report-${{ matrix.python-version }}
          path: safety-report-${{ matrix.python-version }}.json

  # -------------------------
  # Merge Reports
  # -------------------------
  merge-reports:
    runs-on: ubuntu-latest
    needs: [lint-and-test, security]
    steps:
      - name: Download all Safety reports
        uses: actions/download-artifact@v4
        with:
          path: safety-reports
          pattern: safety-report-*
          merge-multiple: true

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: coverage-reports
          pattern: coverage-*
          merge-multiple: true

      - name: Install jq for JSON processing
        run: sudo apt-get install -y jq

      - name: Merge Safety and Coverage Reports
        run: |
          # Initialize summary
          echo "### CI SUMMARY ###" > summary.md
          echo "" >> summary.md
          echo "| Python | Coverage % | Vulnerabilities | Status |" >> summary.md
          echo "|--------|------------|----------------|--------|" >> summary.md
          
          # Process each Python version
          for py_version in 3.11; do
            # Get coverage
            coverage_file="coverage-reports/coverage-${py_version}.xml"
            if [ -f "$coverage_file" ]; then
              coverage=$(python3 -c "
import xml.etree.ElementTree as ET
tree = ET.parse('$coverage_file')
root = tree.getroot()
print(float(root.attrib.get('line-rate', 0.0)) * 100)
" 2>/dev/null || echo "0.0")
            else
              coverage="0.0"
            fi
          
            # Get vulnerabilities
            safety_file="safety-reports/safety-report-${py_version}.json"
            if [ -f "$safety_file" ]; then
              vulns=$(jq length "$safety_file" 2>/dev/null || echo "0")
            else
              vulns="0"
            fi
          
            # Determine status
            if [ "$vulns" -eq "0" ]; then
              status="âœ…"
            else
              status="âš ï¸"
            fi
          
            echo "| ${py_version} | ${coverage} | ${vulns} | ${status} |" >> summary.md
          
            # Create merged safety report
            if [ -f "$safety_file" ] && [ "$(jq length "$safety_file" 2>/dev/null || echo 0)" -gt 0 ]; then
              if [ ! -f "merged-safety-report.json" ]; then
                cp "$safety_file" merged-safety-report.json
              else
                # Merge JSON arrays
                jq -s 'add' merged-safety-report.json "$safety_file" > temp.json && mv temp.json merged-safety-report.json 2>/dev/null || true
              fi
            fi
          done
          
          # Display summary
          cat summary.md
          
          # Check for vulnerabilities
          total_vulns=$(jq length merged-safety-report.json 2>/dev/null || echo 0)
          if [ "$total_vulns" -gt 0 ]; then
            echo "âŒ Vulnerabilities detected! Failing workflow."
            echo "Vulnerabilities found:"
            jq -r '.[] | "  - \(.package_name): \(.vulnerability_id)"' merged-safety-report.json 2>/dev/null || echo "  (Could not parse details)"
            exit 1
          else
            echo "âœ… No vulnerabilities detected."
          fi

      - name: Upload merged Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: merged-safety-report
          path: |
            merged-safety-report.json
            summary.md

  # -------------------------
  # Docker Build
  # -------------------------
  build-docker:
    needs: [lint-and-test, merge-reports]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: covenant-ai-enhanced:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # -------------------------
  # PR Comment
  # -------------------------
  pr-comment:
    runs-on: ubuntu-latest
    needs: merge-reports
    if: github.event_name == 'pull_request'
    steps:
      - name: Download merged Safety report
        uses: actions/download-artifact@v4
        with:
          name: merged-safety-report
          path: ./reports

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          path: ./coverage-reports
          pattern: coverage-*
          merge-multiple: true

      - name: Generate PR comment
        id: generate_comment
        run: |
          python3 - <<'EOF'
          import json, glob, os, xml.etree.ElementTree as ET

          comment_md = "### ðŸ›¡ï¸ Safety Scan & Test Coverage Summary ðŸ›¡ï¸\n\n"

          # Safety
          safety_file = "reports/merged-safety-report.json"
          total_vulns = 0
          if os.path.exists(safety_file):
              with open(safety_file) as f:
                  data = json.load(f)
                  total_vulns = len(data) if isinstance(data, list) else 0
          
          comment_md += "**Safety Scan:**\n"
          comment_md += "| Python Version | Vulnerabilities |\n"
          comment_md += "|---------------|----------------|\n"
          comment_md += f"| 3.11 | {total_vulns} |\n"
          comment_md += f"\n**Total vulnerabilities:** {total_vulns}\n"
          comment_md += "âœ… No vulnerabilities detected.\n" if total_vulns == 0 else "âŒ Vulnerabilities detected! Please review.\n"

          # Coverage
          comment_md += "\n**Test Coverage:**\n"
          comment_md += "| Python Version | Coverage % |\n"
          comment_md += "|---------------|------------|\n"
          
          coverage_files = glob.glob("coverage-reports/coverage-*.xml")
          for file in coverage_files:
              py_version = file.split("-")[-1].replace(".xml", "")
              try:
                  tree = ET.parse(file)
                  root = tree.getroot()
                  coverage_percent = float(root.attrib.get("line-rate", 0.0)) * 100
                  comment_md += f"| {py_version} | {coverage_percent:.1f}% |\n"
              except:
                  comment_md += f"| {py_version} | N/A |\n"

          with open("pr_comment.md", "w") as f:
              f.write(comment_md)
          EOF

      - name: Post comment to PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.pull_request.number }}
          body-file: pr_comment.md

  # -------------------------
  # Notification
  # -------------------------
  notify:
    needs: [lint-and-test, merge-reports, build-docker]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Notify on failure
        if: failure()
        run: echo "âŒ CI failed - check GitHub Actions logs"
