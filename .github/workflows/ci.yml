name: CI - Covenant.AI Enhanced

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:

  # -------------------------
  # Lint & Test Job
  # -------------------------
  lint-and-test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11"]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Upgrade pip and setuptools
        run: python -m pip install --upgrade pip setuptools wheel

      - name: Install dependencies
        run: |
          pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
          pip install numpy pandas scipy transformers sentence-transformers faiss-cpu \
                     web3 ipfshttpclient openai anthropic google-generativeai \
                     prometheus-client jaeger-client \
                     pytest pytest-cov black mypy pylint isort
          pip install -e .

      # -------------------------
      # Formatting & Linting
      # -------------------------
      - name: Sort imports (isort)
        run: isort src tests

      - name: Auto-format with Black
        run: black src tests

      - name: Check formatting (Black)
        run: black --check src tests

      - name: Verify import order (isort)
        run: isort src tests --check-only

      - name: Type check (mypy)
        run: mypy src --ignore-missing-imports

      - name: Lint (pylint)
        run: pylint src || true

      # -------------------------
      # Tests
      # -------------------------
      - name: Run tests
        run: pytest tests --cov=src --cov-report=xml --junitxml=junit/results.xml

      - name: Smoke tests
        run: |
          python workflows/01_setup_environment.py
          python workflows/09_run_basic_tests.py

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.python-version }}
          path: coverage.xml

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.python-version }}
          path: |
            junit/
            coverage.xml
            workflow_setup.log

  # -------------------------
  # Security Scan Job
  # -------------------------
  security:
    runs-on: ubuntu-latest
    needs: lint-and-test
    strategy:
      matrix:
        python-version: ["3.11"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      - name: Install Security Tools
        run: pip install safety==3.6.0 typer==0.9.0 "rich<14"

      - name: Run Safety Security Scan
        run: |
          if [ -f requirements.txt ]; then
            safety check \
              --disable-audit-and-monitor \
              --full-report \
              --file=requirements.txt \
              --json > safety-report-${{ matrix.python-version }}.json || true
          else
            echo "::warning::No requirements.txt found — skipping Safety scan"
          fi

      - name: Upload Safety report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safety-report-${{ matrix.python-version }}
          path: safety-report-${{ matrix.python-version }}.json

  # -------------------------
  # Merge Reports
  # -------------------------
  merge-reports:
    runs-on: ubuntu-latest
    needs: security

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Merge reports
        run: |
          python - <<'EOF'
          import json, glob, sys
          vulns = []
          for f in glob.glob("reports/**/*.json", recursive=True):
              with open(f) as fh:
                  data = json.load(fh)
                  if isinstance(data, list):
                      vulns.extend(data)
          with open("merged-safety-report.json", "w") as out:
              json.dump(vulns, out, indent=2)
          if vulns:
              print("❌ Vulnerabilities detected")
              sys.exit(1)
          print("✅ No vulnerabilities detected")
          EOF

      - uses: actions/upload-artifact@v4
        with:
          name: merged-safety-report
          path: merged-safety-report.json

  # -------------------------
  # Docker Build
  # -------------------------
  build-docker:
    needs: [lint-and-test, merge-reports]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile
          push: false
          tags: covenant-ai-enhanced:ci-test

  # -------------------------
  # Notification
  # -------------------------
  notify:
    needs: [lint-and-test, merge-reports, build-docker]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Notify on failure
        if: failure()
        run: echo "❌ CI failed - check GitHub Actions logs"
