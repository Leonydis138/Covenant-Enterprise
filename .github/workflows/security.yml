name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0'  # Run weekly on Sunday at midnight
  workflow_dispatch:

permissions:
  contents: read

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            echo "No requirements.txt found, installing common packages"
            pip install torch torchvision transformers
          fi

      - name: Run Safety vulnerability scan
        id: safety
        run: |
          # Install safety
          pip install safety
          
          # Generate requirements for scanning
          pip freeze > safety-requirements.txt
          
          # Run safety check
          safety check \
            --disable-audit-and-monitor \
            --full-report \
            --file=safety-requirements.txt \
            --json > safety-report.json || echo '[]' > safety-report.json
          
          # Count vulnerabilities
          vuln_count=$(python -c "
import json
try:
    with open('safety-report.json') as f:
        data = json.load(f)
        print(len(data) if isinstance(data, list) else 0)
except:
    print(0)
")
          echo "vuln_count=$vuln_count" >> $GITHUB_OUTPUT
          
          if [ $vuln_count -gt 0 ]; then
            echo "Found $vuln_count vulnerabilities"
            echo "Vulnerabilities:"
            python -c "
import json
try:
    with open('safety-report.json') as f:
        data = json.load(f)
        for vuln in data:
            print(f'  â€¢ {vuln.get(\"package_name\", \"Unknown\")}: {vuln.get(\"vulnerability_id\", \"Unknown\")}')
except:
    pass
"
          else
            echo "No vulnerabilities found"
          fi

      - name: Run Bandit security linter
        id: bandit
        run: |
          # Install bandit
          pip install bandit
          
          # Run bandit on source code
          bandit -r src/covenant -f json -o bandit-report.json || echo '{"errors": [], "generated_at": "", "metrics": {}, "results": []}' > bandit-report.json
          
          # Count issues
          issue_count=$(python -c "
import json
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
        print(len(data.get('results', [])))
except:
    print(0)
")
          echo "bandit_issues=$issue_count" >> $GITHUB_OUTPUT
          
          if [ $issue_count -gt 0 ]; then
            echo "Found $issue_count security issues with Bandit"
          else
            echo "No Bandit security issues found"
          fi

      - name: Check for vulnerable GitHub Actions
        id: action-security
        run: |
          # Check for pinned action versions
          echo "Checking GitHub Actions versions..."
          if grep -r "actions/.*@[a-zA-Z]" .github/workflows/ | grep -v "@v[0-9]" | grep -v "@main" | grep -v "@master"; then
            echo "::warning::Some GitHub Actions are not pinned to specific versions"
          else
            echo "All GitHub Actions are properly version-pinned"
          fi

      - name: Generate security summary
        if: always()
        run: |
          echo "# Security Scan Summary" > security-summary.md
          echo "## Generated on $(date)" >> security-summary.md
          echo "" >> security-summary.md
          
          # Safety results
          vuln_count="${{ steps.safety.outputs.vuln_count }}"
          echo "### ðŸ”’ Dependency Security (Safety)" >> security-summary.md
          echo "- **Vulnerabilities found:** $vuln_count" >> security-summary.md
          
          if [ "$vuln_count" -gt 0 ] && [ -f "safety-report.json" ]; then
            echo "" >> security-summary.md
            echo "**Top vulnerabilities:**" >> security-summary.md
            python -c "
import json
try:
    with open('safety-report.json') as f:
        data = json.load(f)
        for i, vuln in enumerate(data[:3]):  # Show top 3
            print(f'- **{vuln.get(\"package_name\", \"Unknown\")}** (CVE: {vuln.get(\"vulnerability_id\", \"Unknown\")})')
            print(f'  - {vuln.get(\"advisory\", \"No advisory available\")[:200]}...')
except:
    pass
" >> security-summary.md
          fi
          
          # Bandit results
          bandit_issues="${{ steps.bandit.outputs.bandit_issues }}"
          echo "" >> security-summary.md
          echo "### ðŸ” Code Security (Bandit)" >> security-summary.md
          echo "- **Issues found:** $bandit_issues" >> security-summary.md
          
          if [ "$bandit_issues" -gt 0 ] && [ -f "bandit-report.json" ]; then
            echo "" >> security-summary.md
            echo "**Example issues:**" >> security-summary.md
            python -c "
import json
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
        for i, issue in enumerate(data.get('results', [])[:2]):  # Show first 2
            print(f'- **{issue.get(\"test_name\", \"Unknown\")}** in {issue.get(\"filename\", \"Unknown\")}:{issue.get(\"line_number\", \"?\")}')
            print(f'  - Severity: {issue.get(\"issue_severity\", \"Unknown\")}, Confidence: {issue.get(\"issue_confidence\", \"Unknown\")}')
except:
    pass
" >> security-summary.md
          fi
          
          # Display summary
          cat security-summary.md

      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            safety-report.json
            bandit-report.json
            security-summary.md

      - name: Fail on critical vulnerabilities
        if: steps.safety.outputs.vuln_count != '0'
        run: |
          echo "::error::Critical security vulnerabilities detected!"
          echo "Check the safety-report.json artifact for details."
          exit 1
